---
// Dashboard page that checks for user authentication and displays user-specific content //

import Layout from "../layouts/baseLayout.astro";
import { supabase } from "../lib/supabase";
export const prerender = false;
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin");
}

const email = session.data.user?.email;
---
<Layout title="Dashboard">
<script type="module" src="/scripts/dashboardAuth.js"></script>

  <link rel="stylesheet" href="../../styles/dashboard.css">
  <h1>Welcome {email}</h1>
  <p>We are happy to see you here</p>
  
  <!-- Sign out form -->
  <form action="/api/auth/signout">
    <button type="submit">Sign out</button>
  </form>
  <!-- Form to delete account -->
  <form
    method="POST"
    action="/api/account/delete"
    onsubmit="return confirm('This will permanently delete your account. Are you sure?')"
  >
    <button type="submit" style="color:red">
      Delete my account
    </button>
  </form>

  <!-- Form to create a new post -->
  <form method="POST" action="../api/posts/push" class="spost-form">
    <input
      type="text"
      name="title"
      placeholder="Title"
      required
    />

    <textarea
      name="content"
      placeholder="Write your post..."
      required
    ></textarea>

    <button type="submit">Publish</button>
  </form>

  <script type="module" src="/scripts/sposts.js"></script>

  <div id="sposts"></div>

  

</Layout>